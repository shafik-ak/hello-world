const { composition } = require('@sap/cds-sql')
const { isCustomOperation } = require('../../adapter/odata-v4/utils/request')

// -----------------------------------------------------------------------------------
// TODO odata-specific helpers for ../handlers/onCreateDraft - to be moved or replaced
// -----------------------------------------------------------------------------------
const isNavigationToMany = context => {
  const segments = context._.odataReq.getUriInfo().getPathSegments()
  return segments[segments.length - 1].getKind() === 'NAVIGATION.TO.MANY'
}

// copied from adapter/odata-v4/utils/context-object
const _findSourceEntityNameAtService = (service, name) => {
  const serviceEntity = service.model.find(element => {
    return (
      (element.query && element.query.target && element.query.target.name === name) ||
      (element.name !== 'DRAFT.DraftAdministrativeData' && element.source === name)
    ) // OLD CSN
  })

  return serviceEntity ? serviceEntity.name : name
}

// copied from adapter/odata-v4/utils/context-object
const _getTargetEntityName = (service, pathSegments) => {
  if (isCustomOperation(pathSegments, false)) {
    return undefined
  }

  let navSegmentName
  let entityName = `${service.name}.${pathSegments[0].getEntitySet().getName()}`

  for (const navSegment of pathSegments.filter(segment => segment.getNavigationProperty() !== null)) {
    navSegmentName = navSegment.getNavigationProperty().getName()
    entityName = service.model.definitions[entityName].elements[navSegmentName].target
  }

  return _findSourceEntityNameAtService(service, entityName)
}

const isDraftEnabled = (definitions, entityName) => {
  const entity = definitions[entityName]

  if (!entity) {
    return false
  }

  const { getEntityName } = require('./draftUtils')

  return (
    getEntityName(entityName) === 'DraftAdministrativeData' ||
    !!composition.getCompositionRoot(definitions, entity)['@odata.draft.enabled']
  )
}
/**
 * Provide information about the parent entity, i.e. the entity that has the to-many composition element.
 * Limitation: only works for one key (besides IsActiveEntity)
 * @param service
 * @param context
 * @returns {Object}
 * @private
 */
const getParent = (service, context) => {
  const segments = context._.odataReq.getUriInfo().getPathSegments()

  if (segments.length === 1) return

  const parent = {
    entityName: _getTargetEntityName(service, segments.slice(0, segments.length - 1))
  }

  const parentKeyPredicates = segments[segments.length - 2].getKeyPredicates()
  let keyPredicateName, keyPredicateText
  for (const keyPredicate of parentKeyPredicates) {
    keyPredicateName = keyPredicate.getEdmRef().getName()
    keyPredicateText = keyPredicate.getText()

    if (keyPredicateName === 'IsActiveEntity') {
      parent.IsActiveEntity = keyPredicateText
    } else {
      parent.keyName = keyPredicateName
      parent.keyValue = keyPredicateText
    }
  }

  return parent
}

const _getCompositionSetInternal = (model, parentEntityName, compositions) => {
  compositions.add(parentEntityName)
  const parentEntity = model[parentEntityName]
  const subCompositions = Object.keys(parentEntity.elements)
    .map(key => parentEntity.elements[key])
    .filter(({ type, name }) => type === 'cds.Composition' && name !== 'texts')
  for (const { target } of subCompositions) {
    if (!compositions.has(target)) {
      _getCompositionSetInternal(model, target, compositions)
    }
  }
}

/**
 * Provides set of all underlying compositions.
 * @param {Object} model Definitions of the reflected model
 * @param {String} EntityName Name of the entity
 */
const getDraftCompositionSet = (model, EntityName) => {
  const compositions = new Set()
  _getCompositionSetInternal(model, EntityName, compositions)

  return compositions
}

/**
 * Returns true/false if entity is root of a document in a draft enabled service.
 * @param {Object} definitions Definitions of the reflected model
 * @param {String} entityName Name of the entity
 */
const isDraftRootEntity = (definitions, entityName) => {
  if (definitions[entityName] && definitions[entityName]['@odata.draft.enabled']) {
    return composition.isRootEntity(definitions, entityName)
  }

  return false
}

module.exports = {
  selectDeepUpdateData: composition.selectDeepUpdateData,
  propagateKeys: composition.propagateKeys,
  getDraftCompositionSet,
  getDraftCompositionTree: composition.getDraftCompositionTree,
  getCompositionRoot: composition.getCompositionRoot,
  getParent,
  isNavigationToMany,
  isDraftEnabled,
  isDraftRootEntity
}
