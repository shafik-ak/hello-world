/**
 * @param {object} req - the request object
 * @returns {string} - the client user as string
 * @private
 */
const getUserFromRequest = req => {
  if (req.headers['authorization']) {
    const [type, value] = req.headers['authorization'].split(' ')

    if (type.toLowerCase() === 'basic' && value) {
      const [user, ...parts] = Buffer.from(value, 'base64')
        .toString()
        .split(':')
      return parts.length === 1 ? user : undefined
    }
  }
}

/**
 * If the client is behind a proxy, the xx-forwarded-for header needs to be evaluated.
 * We take the "best effort" and assume the last IP in this header is the client IP.
 * Falls back to remote address of req.connection object.
 * @param {object} req - the request object
 * @returns {string} - the client ip as string
 * @private
 */
const getIpFromRequest = req => {
  const xForwardedFor = req.headers['x-forwarded-for']
  if (xForwardedFor) {
    const ips = xForwardedFor.split(',')

    return ips[ips.length - 1].trim()
  }

  return req.connection.remoteAddress
}

module.exports = { getIpFromRequest, getUserFromRequest }
