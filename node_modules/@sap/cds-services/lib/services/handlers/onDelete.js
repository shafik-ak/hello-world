const {
  messages: { DB_CONNECTION_MISSING }
} = require('../utils/constants')
const getColumns = require('../utils/columns')

const _getSelectCQN = context => {
  const select = context.statements.SELECT.from(context.target, getColumns(context.target, true))
  select.SELECT.where = context.query.DELETE ? context.query.DELETE.where : context.query.UPDATE.where

  return select
}

/**
 * Generic Handler for DELETE requests.
 * In case of success it returns an empty object.
 * If the entry to be deleted does not exist, it rejects with error to return a 404.
 *
 * @param context - operation object, that provides error, continuation and other functions as well as information
 * regarding the current operation.
 * @alias module:handlers.onDelete
 */
const onDelete = () => async context => {
  if (!context.run) {
    context.log.warn(DB_CONNECTION_MISSING)
    return Promise.resolve()
  }

  const result = await context.run(_getSelectCQN(context))

  if (result.length === 0) {
    context.reject(404)
    return
  }

  if (context._.odataReq && context._.odataReq.isConditional()) {
    const element = Object.values(context.target.elements).find(element => {
      return element['@odata.etag']
    })
    context._.odataReq.validateEtag(result[0][element.name])
  }

  context._oldData = result[0]

  await context.run(context.query)
  return undefined
}

module.exports = onDelete
