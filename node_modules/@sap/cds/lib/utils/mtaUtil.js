const fs = require('@sap/cds-foss')('fs-extra')
const path = require('path')

const DEBUG = process.env.DEBUG
const HDI_CONTAINER_TYPE = 'com.sap.xs.hdi-container'
const UTF_8 = 'utf-8'
const MTA_YAML = 'mta.yaml'

async function getHdiService(projectPath, modulePath, logger) {
    if (!projectPath || !modulePath || !logger) {
        throw new Error('Invalid parameter')
    }

    const moduleName = path.basename(modulePath)

    // mta might be null if mta.yaml does not exist
    const mta = await _getMta(projectPath, logger)
    return _findHdiResource(mta, moduleName, logger)
}

function getDefaultHdiServiceName(projectPath, modulePath) {
    return `${path.basename(projectPath)}-${path.basename(modulePath)}-hdi-container`;
}

async function getApplicationName(projectPath, modulePath, moduleType, logger) {
    if (!projectPath || !modulePath || !logger) {
        throw new Error('Invalid parameter')
    }
    // mta might be null if mta.yaml does not exist
    const mta = await _getMta(projectPath, logger)
    const moduleName = path.basename(modulePath)

    const module = _findModule(mta, moduleName, moduleType)

    return module ? module.name : `${path.basename(projectPath)}-${moduleName}`
}

async function findModules(projectPath, logger) {
    if (!projectPath || !logger) {
        throw new Error('Invalid parameter')
    }
    const mta = await _getMta(projectPath, logger)

    if (mta && Array.isArray(mta.modules)) {
        return mta.modules
    }
    return []
}

async function _getMta(projectPath, logger) {
    // yaml.parse  oesn't like null
    const mtaFilePath = path.join(projectPath, MTA_YAML)

    const existsMtaYaml = await fs.pathExists(mtaFilePath)
    if (!existsMtaYaml) {
        if (DEBUG) {
            logger.log('[cds] - mta.yaml not existing')
        }
        return null
    }

    const yamlStr = await fs.readFile(mtaFilePath, UTF_8)

    // yaml returns null if string couldn't be parsed, e.g. empty string
    return require('@sap/cds-foss')('yaml').parse(yamlStr)
}

function _findModules(mta, moduleType) {
    let modules = []
    if (mta && Array.isArray(mta.modules)) {
        modules = mta.modules.filter(module => module.type === moduleType)
    }
    return modules
}

function _findModule(mta, moduleName, moduleType) {
    const modules = _findModules(mta, moduleType)
    if (modules.length === 1) {
        return modules[0]
    } else if (modules.length > 1) {
        return modules.find(module => typeof module.path === 'string' && module.path.includes(moduleName))
    }
    return null
}

function _findHdiResource(mta, moduleName, logger) {
    if (mta && Array.isArray(mta.resources)) {
        const hdiResources = mta.resources.filter(resource => resource.type === HDI_CONTAINER_TYPE)

        if (hdiResources.length > 0) {
            if (Array.isArray(mta.modules)) {
                const module = _findModule(mta, moduleName, 'hdb')
                if (module && Array.isArray(module.requires)) {
                    return hdiResources.find(hdiResource =>
                        module.requires.find(req =>
                            hdiResource.name === req.name
                        )
                    )
                }
            }

            logger.warn(`No matching hdi resource found for ${moduleName}. Using ${hdiResources[0].name}.`)
            return hdiResources[0]
        }
    }

    return null
}

module.exports = {
    findModules,
    getApplicationName,
    getDefaultHdiServiceName,
    getHdiService,
    MTA_YAML
}
