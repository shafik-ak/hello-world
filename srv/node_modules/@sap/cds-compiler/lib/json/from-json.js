/**
 * This module is used for parsing csn as json and returned as augmented CSN.
 * @param source json formatted string representation of the csn
 * @param file name if the originating file - used for error reporting
 * @param options augmentor options
 */

function fromJson(source, filename, options) {
  let jlParser = require("./parse")

  // parse json with locations
  let augmentedJSON = jlParser.parse( source, filename );

  let model = augmentedJSON.condense();

  let newCsn=require("./csnVersion").isNewCSN(model,options);

  // augment CSN
  if(newCsn) {

      // CSN validation
    let validateCSN = require("./validator/validateCSN.js");
    validateCSN(model, options);

    let augmentor3 = require("./augmentor3.js");
    augmentor3.augment(model);
  } else {
    let augmentor = require("./augmentor.js");
    augmentor.augment(model , filename, options );
  }
  delete model["locations"];
  // The CSN parser does not use the normal message function:
  if (options.messages && model.messages)
    options.messages.push( ...model.messages );
  return model;
}

module.exports = fromJson
