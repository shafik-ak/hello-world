/* eslint-disable no-console */
const { dirname, join } = require ('path')
module.exports = Object.assign(list_versions, {
  flags: ['--markdown', '--all'],
  shortcuts: ['-m','-a'],
  info,
  help: `
# SYNOPSIS

    *cds version*
    *cds -v*

    Prints the version of CDS
`})

function list_versions(_, options) {
  const { markdown, noColors } = options
  const versions = info (options)
  if (markdown)  return _markdown (versions)
  const mark = noColors ? s => s : require('./utils/term').info
  for (let each in versions)  console.log(`${mark(each)}: ${versions[each]}`)
}

function info(o) {
  const main = _findPackage (require.main.filename)
  return {
    ..._versions4(main, {}, true),  // usually sap/cds-dk or sap/cds
    ..._versions4('..', {}, null, o),
    'Node.js': process.version,
    'home': __dirname.slice(0,-4)
  }
}

function _versions4 (pkg_name, info, parent, o={}) {
  try {
    const pkg = require(join(pkg_name, 'package.json'))
    info[pkg.name] = pkg.version
    if (!parent || o.all) for (let d in pkg.dependencies) { // recurse sap packages in dependencies...
      if (!(d in info) && d.startsWith('@sap/')) _versions4(d, info, pkg.name, o)
    }
  } catch (e) {
    if (e.code !== 'MODULE_NOT_FOUND') info[pkg_name] = '-- missing --'  // unknown error
    // require fails for indirect packages if node_modules layout is nested, e.g. on Windows.
    // Try one more time with nested node_modules dir.
    else if (parent) _versions4(parent + '/node_modules/' + pkg_name, info)
  }
  return info
}

const v = (version='') => (version.replace(/-SNAPSHOT.*/,'') + '                     ').slice(0,21)
const _ = (p=process.cwd()) => {
  try {       return require (join(p, 'package.json')) }
  catch (e) { return { name: '', repository: '', version: ''} }
}
function _markdown (versions) {
  const p = _()
  console.log(`
| Node.js   | @sap/cds-dk           | @sap/cds              | @sap/cds-compiler     | Node.js runtime       | Your Project: |
| --------- | --------------------- | --------------------- | --------------------- | --------------------- | ------------- |
| ${
  process.version }  | ${
  v(versions['@sap/cds-dk']) } | ${
  v(versions['@sap/cds']) } | ${
  v(versions['@sap/cds-compiler'])} | ${
  v(versions['@sap/cds-services'])} | [${
  p.name}](${p.repository? (p.repository.url || p.repository) : ''}) |
`)}

function _findPackage (dir) {
  try {
    if (dir) {
      require.resolve(join (dir, 'package.json'))
      return dir
    }
  } catch (e) {
    if (e.code !== 'MODULE_NOT_FOUND')  throw e
    return _findPackage (dirname (dir))
  }
}
