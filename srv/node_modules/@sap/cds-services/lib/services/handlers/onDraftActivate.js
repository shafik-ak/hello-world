const {
  setStatusCodeAndHeader,
  getEntityName,
  ensureDraftsSuffix,
  ensureNoDraftsSuffix
} = require('../utils/draftUtils')
const { getKeyData } = require('../utils/draftWhereUtils')
const { checkIntegrity } = require('../utils/handlerUtils')
const { resolveCqnIfView } = require('../utils/defaultHandlers')

const _adaptResult = result => {
  result.IsActiveEntity = true
  result.HasActiveEntity = false
  result.HasDraftEntity = false
  delete result.DraftAdministrativeData_DraftUUID

  return result
}

const _getKeysObj = context => {
  let keysObj = {}

  if (context.query.UPDATE) {
    keysObj = getKeyData(Object.keys(context.target.keys), context.query.UPDATE.where)
  }

  if (context.query.INSERT) {
    for (const key in context.query.INSERT.entries[0]) {
      if (Object.keys(context.target.keys).includes(key)) {
        keysObj[key] = context.query.INSERT.entries[0][key]
      }
    }
  }
  return keysObj
}

const _getDeleteDraftAdminCqn = (draftUUID, DELETE) =>
  DELETE.from('DRAFT.DraftAdministrativeData').where([{ ref: ['DraftUUID'] }, '=', { val: draftUUID }])

const _getRootWhere = context => {
  const keysObj = _getKeysObj(context)

  const rootWhere = []
  for (const key in keysObj) {
    rootWhere.push({ ref: [key] }, '=', { val: keysObj[key] })
  }

  return rootWhere
}

const _getDeleteRootDraftCqn = (targetName, rootWhere, DELETE) => DELETE.from(targetName).where(rootWhere)

/**
 * Generic Handler for ActivationAction requests.
 * In case of success it returns the prepared draft entry.
 *
 * @param context - operation object, that provides error, continuation and other functions as well as information
 * regarding the current operation.
 * @alias module:handlers.onDraftActivate
 */
const onDraftActivate = () => async context => {
  const rootWhere = _getRootWhere(context)

  const deleteDraftAdminCqn = _getDeleteDraftAdminCqn(context.draftMetadata.DraftUUID, context.statements.DELETE)
  const deleteRootDraftCqn = _getDeleteRootDraftCqn(
    ensureDraftsSuffix(context.target.name),
    rootWhere,
    context.statements.DELETE
  )

  await Promise.all([deleteDraftAdminCqn, deleteRootDraftCqn, resolveCqnIfView(context)].map(cqn => context.run(cqn)))

  await checkIntegrity(context)

  setStatusCodeAndHeader(
    context._.odataRes,
    _getKeysObj(context),
    getEntityName(ensureNoDraftsSuffix(context.target.name)),
    true
  )
  return _adaptResult(Object.assign({}, context.data))
}

module.exports = onDraftActivate
