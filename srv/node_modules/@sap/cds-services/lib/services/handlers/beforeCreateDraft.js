const { isNavigationToMany } = require('../utils/compositionTree')
const { isDraftActivateAction } = require('../utils/draftUtils')
const { addDraftDataFromExistingDraft, addGeneratedDraftUUID } = require('../utils/handlerUtils')

/**
 * Generic Handler for before CREATE requests.
 *
 * @param service
 * @alias module:handlers.beforeCreateDraft
 */
const beforeCreateDraft = service => async context => {
  if (isDraftActivateAction(context)) {
    return
  }
  if (isNavigationToMany(context)) {
    const result = await addDraftDataFromExistingDraft(context, service)
    // in order to fix strange case where active subitems are created in draft case
    if (result.length === 0) {
      context.reject(404)
      return
    }
  } else {
    addGeneratedDraftUUID(context)
  }
  context.isDraftChange = true
  context.draft = context.data.DraftAdministrativeData_DraftUUID // deprecated
}

module.exports = beforeCreateDraft
